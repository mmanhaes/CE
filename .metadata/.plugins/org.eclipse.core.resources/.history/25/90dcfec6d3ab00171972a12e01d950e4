console.log("Iniciando CEAI Cadastro de Participantes Server...");
var express = require('express');
var config = require('./config');
var app = express();
var bodyParser = require("body-parser");
var vcapServices = require('vcap_services');
const uuidv1 = require('uuid/v1');
//Variables used for authentication
var passport = require('passport');
var Strategy = require('passport-local').Strategy;
var auth = require('./auth');
//Variables for Cloudant
var Cloudant = require('cloudant');
var credentials = vcapServices.getCredentials('cloudantNoSQLDB', 'Lite', config.cloudant.instance);
var dbURL =  credentials.url || config.cloudant.url; 
var cloudant = Cloudant(dbURL);
//Variables for port
var port = (process.env.PORT || process.env.VCAP_APP_PORT || 3000);

passport.use(new Strategy(
		function(username, password, cb) {
			auth.users.findByUsername(username, function(err, user) {
				if (err) { return cb(err); }
				if (!user) { return cb(null, false); }
				if (user.password !== password) { return cb(null, false); }
				return cb(null, user);
			});
		}));

passport.serializeUser(function(user, cb) {
	cb(null, user.id);
});

passport.deserializeUser(function(id, cb) {
	auth.users.findById(id, function (err, user) {
		if (err) { return cb(err); }
		cb(null, user);
	});
});

//Configure view engine to render EJS templates.
app.set('views', __dirname + '/public/views');
app.set('view engine', 'ejs');

//Use application-level middleware for common functionality, including
//logging, parsing, and session handling.
app.use(require('morgan')('combined'));
app.use(require('cookie-parser')());
app.use(require('body-parser').urlencoded({ extended: true }));
app.use(require('express-session')({ secret: 'keyboard cat', resave: false, saveUninitialized: false }));

//Initialize Passport and restore authentication state, if any, from the
//session.
app.use(passport.initialize());
app.use(passport.session());

app.use(express.static("public"));
app.use(express.static("node_modules/bootstrap/dist"));
app.use(bodyParser.urlencoded({ extended: false }));

//parse application/json
app.use(bodyParser.json());

var buildSelector = function(data,callback){
	if (data.lastName!=="" && data.firstName!=="" && data.middleName!=="")
	{
		fullName_selector.selector.firstName = data.firstName;
		fullName_selector.selector.middleName = data.middleName;
		fullName_selector.selector.lastName = data.lastName;
		
		return callback(fullName_selector);
	}	
	else{
		if (data.lastName!=="" && data.firstName!=="")
		{
			fullName_selector.selector.firstName = data.firstName;
			fullName_selector.selector.lastName = data.lastName;
		}
		else
		{
			if (data.firstName!=="")
			{				
				fullName_selector.selector.firstName = data.firstName;
			}			
		}			
	}
	return callback(null);
};

app.post('/services/ceai/searchPerson', function(req, res){
	res.setHeader('Content-Type', 'text/plain');
	
	var db = cloudant.db.use(config.database.name);
	
	var selector = "";
	buildSelector(req.body,function(response){
		
	});

	db.find({selector:{name:'Alice'}}, function(er, result) {
		  if (er) {
		    throw er;
		  }
		 
		  console.log('Found %d documents with name Alice', result.docs.length);
		  for (var i = 0; i < result.docs.length; i++) {
		    console.log('  Doc id: %s', result.docs[i]._id);
		  }
	});
	res.write('Requisicão Salva com Sucesso com o ID :'+req.body.userID +'\n');
	res.end('para o participante : '+ req.body.firstName+ " "+ req.body.middleName+" "+req.body.lastName);	 
});

app.post('/services/ceai/inputGeneral', function(req, res){
	res.setHeader('Content-Type', 'text/plain');
	cloudant.db.list(function(err, allDbs) {
		console.log('All my databases: %s', allDbs.join(', '));
	});
	console.log(JSON.stringify(req.body, null, 2));

	var db = cloudant.db.use(config.database.name);
	var id =  uuidv1();

	db.insert(req.body, id, function(err, body, header) {
		if (err) {
			return console.log('[db.insert] ', err.message);
		}

		console.log('You have inserted the record.');
		console.log(body);
		console.log('With Content :');
		console.log(JSON.stringify(req.body, null, 2));
	});
	res.write('Requisicão Salva com Sucesso com o ID :'+req.body.userID +'\n');
	res.end('para o participante : '+ req.body.firstName+ " "+ req.body.middleName+" "+req.body.lastName);	 
});

app.get('/',
		function(req, res){
	res.redirect('/home');
});

app.get('/home',
		require('connect-ensure-login').ensureLoggedIn(),
		function(req, res){
	res.sendFile(__dirname + "/public/home.html");
});

app.get('/login',
		function(req, res){
	res.render('login');
});

app.post('/login', 
		passport.authenticate('local', { failureRedirect: '/login' }),
		function(req, res) {
	res.redirect('/');
});

app.get('/logout',
		function(req, res){
	req.logout();
	res.redirect('/');
});

app.get('/General',
		require('connect-ensure-login').ensureLoggedIn(),
		function(req, res){
	res.sendFile(__dirname + "/public/general.html");
});

app.get('/Contact',
		require('connect-ensure-login').ensureLoggedIn(),
		function(req, res){
	res.sendFile(__dirname + "/public/contact.html");
});

app.get('/Work',
		require('connect-ensure-login').ensureLoggedIn(),
		function(req, res){
	res.sendFile(__dirname + "/public/work.html");
});

app.get('/Study',
		require('connect-ensure-login').ensureLoggedIn(),
		function(req, res){
	res.sendFile(__dirname + "/public/study.html");
});

app.get('/Association',
		require('connect-ensure-login').ensureLoggedIn(),
		function(req, res){
	res.sendFile(__dirname + "/public/association.html");
});

app.listen(port,function(){
	console.log('CEAI Cadastro de Participantes Server running on port:'+port);
});

