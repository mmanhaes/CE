/**
 * Copyright 2015 IBM Corp. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* global $ */
'use strict';

var fwDescriptions=[];

function download(filename, text) {
	var pom = document.createElement('a');
	pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
	pom.setAttribute('download', filename);

	if (document.createEvent) {
		var event = document.createEvent('MouseEvents');
		event.initEvent('click', true, true);
		pom.dispatchEvent(event);
	}
	else {
		pom.click();
	}
}

function validateFields(callback){
	if ($.trim($('#fullName').val()) === '' || $.trim($('#rg').val()) === '' || $.trim($('#rg-exp').val()) === '' ||
		 $.trim($('#day').val()) === '' || $.trim($('#month').val()) === '' || $.trim($('#year').val()) === '' || 
			$.trim($('#address').val()) === '' || $.trim($('#number').val()) === '' || 
			  $.trim($('#complement').val()) === '' || $.trim($('#neighborhood').val()) === '' ||
				   $.trim($('#neighborhood').val()) === '' || $.trim($('#PostCode-1').val()) === ''-1 ||
				   $.trim($('#PostCode-2').val()) === '')  
	{
		return callback(false,"");
	}	
	
	var res = $.trim($('#fullName')).split(" ");
	if (res.length ===1){
		return callback(false,"Nome do participante precisa estar completo");
	}
	
	var rg_state = document.getElementById("rg-state");
	var state = document.getElementById("state");
	
	if (rg_state.selectedIndex === 0 || state.selectedIndex === 0 ){

		return callback(false,"");
	}

	return callback(true,"");
}

function splitFullName(name,callback){
	var res = name.split(" ");
	var response = {
			firstName: "",
			lastName: "",
			middleName: ""
	};
	if (res.length ===1 )
	{
		response.firstName = name;
		return callback(response);
	}
	response.firstName = res[0];
	response.lastName = res[res.length-1];
	var middleName = "";
	for (var i=1; i<res.length-1;++i){
		middleName += " "+res[i];
	}
	response.middleName = middleName;
	return callback(response);
}

function getCustomerID(){
	var currentdate = new Date(); 
	return  currentdate.getFullYear() 
					+ "-" + (currentdate.getMonth()+1) 
					+ "-" + currentdate.getDay()					 
					+ "-" + currentdate.getHours()  
	                + "-" + currentdate.getMinutes() 
	                + "-" + currentdate.getSeconds()
	                + "-" + currentdate.getMilliseconds();
}

$(document).ready(function() {
	$('#insert').click(function(){
		alert('Insert Button'); 
		var $output = $('.output'),
		$process = $('.processing');	
		validateFields(function(valid,response){
			if (valid === false){
				if (response !== "")
					alert(response);
				else
					alert('It needs to have all fields filled');
				return;
			}
		}); 
		$process.show();
		$output.hide();
		var rg_state = document.getElementById("rg-state");
		var state = document.getElementById("state");
		var respNames = "";
		splitFullName($.trim($('#fullName').val()),function(response){
			respNames = response;
		});
		
		//+'"confidential" : "'+confidential.options[confidential.selectedIndex].value+'",'
		var inputGeneral = '{'
			+'"userID" : "'+getCustomerID()+'",'
			+'"firstName" : "'+respNames.firstName+'",'
			+'"middleName" : "'+respNames.middleName+'",'
			+'"lastName" : "'+respNames.lastName+'",'
			+'"rg" : "'+$.trim($('#rg').val())+'",'
			+'"rgExp" : "'+$.trim($('#rg-exp').val())+'",'
			+'"rgState" : "'+rg_state.options[rg_state.selectedIndex].value+'",'
			+'"birthDate" : "'+$.trim($('#day').val())+'-'+$.trim($('#month').val())+'-'+$.trim($('#year').val())+'",'
			+'"address" : "'+$.trim($('#address').val())+'",'
			+'"number" : "'+$.trim($('#number').val())+'",'
			+'"complement" : "'+$.trim($('#complement').val())+'",'
			+'"neighborhood" : "'+$.trim($('#neighborhood').val())+'",'
			+'"city" : "'+$.trim($('#city').val())+'",'
			+'"state" : "'+state.options[state.selectedIndex].value+'",'
			+'"postCode" : "'+$.trim($('#PostCode-1').val())+'-'+$.trim($('#PostCode-2').val())+'"}';

		console.log(JSON.stringify(inputGeneral));

		$.ajax({
			url: '/services/ceai/inputGeneral',
			type: 'POST',
			data: inputGeneral,
			contentType: "application/json",
			success: function(data, textStatus, jqXHR){
					$('#results').text(data);
					$process.hide();
					$output.show(); 				      	           
			},
			error: function(jqXHR, textStatus, errorThrown){
				$('#message').html('Error on Process: '+ jqXHR.responseText+' status: '+jqXHR.statusText);
				//alert('Error on Process: '+ jqXHR.responseText+' status: '+jqXHR.statusText);
				$process.hide();
				$output.show(); 
			}
		});
	});	
});
