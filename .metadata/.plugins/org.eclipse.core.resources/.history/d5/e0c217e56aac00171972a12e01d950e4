/**
 * Copyright 2015 IBM Corp. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* global $ */
'use strict';

var fwDescriptions=[];

function cleanSearchOutput(){
	var table = document.getElementById("tableResult");
	for (var i = 1; i < table.rows.length; i++) {
		table.deleteRow(i);
	} 	
}

function buildSearhOutput(data){
	 
	    var table = document.getElementById("tableResult");

	    for (var i = 0; i < data.docs.length; i++) {
		    var rowCount = table.rows.length;
		    var row = table.insertRow(rowCount);
	
		    row.insertCell(0).innerHTML= '<input type="radio" name="group1">';
		    row.insertCell(1).innerHTML= data.docs[i].userID;
		    if (data.docs[i].middleName !== "")
		    	row.insertCell(2).innerHTML= data.docs[i].firstName+" "+data.docs[i].middleName+" "+data.docs[i].lastName;
		    else
		    	row.insertCell(2).innerHTML= data.docs[i].firstName+" "+data.docs[i].lastName;
		    row.insertCell(3).innerHTML= data.docs[i].firstName+" "+data.docs[i].mainPhone;
		    row.insertCell(4).innerHTML= data.docs[i].firstName+" "+data.docs[i].Email_1;
		    row.insertCell(5).innerHTML= data.docs[i].firstName+" "+data.docs[i].associationType;
		    row.insertCell(5).innerHTML= data.docs[i].firstName+" "+data.docs[i].mainActivity;
	    }
}

function validateFields(){
	if ($.trim($('#fullName').val()) === '')  
	{
		return false;
	}	
	
	return true;
}

function splitFullName(name,callback){
	var res = name.split(" ");
	var response = {
			firstName: "",
			lastName: "",
			middleName: ""
	};
	if (res.length ===1 )
	{
		response.firstName = name;
		return callback(response);
	}
	response.firstName = res[0];
	response.lastName = res[res.length-1];
	var middleName = "";
	for (var i=1; i<res.length-1;++i){
		middleName += " "+res[i];
	}
	response.middleName = middleName;
	return callback(response);
}

$(document).ready(function() {
   
   $('#download').click(function(){
	    var filename = ''; 
	    if ($.trim($('#query').val()) == '')
	    	filename = 'FireBotSearch-Result-'+ $.trim($('#query').val())+'.txt';
	    else
	    	filename = 'FireBotSearch-Result-'+ $.trim($('#query').val())+'-'+$.trim($('#port').val())+'.txt';
	    
		download(filename, $('#results').text());
	});	
	
  $('#search').click(function(){
	//alert('Search Button'); 
	var $output = $('.output'),
	$error = $('.error'),
	$process = $('.processing');	
	if (validateFields()===false){	
		alert('Favor preencher um nome para pesquisar, pode ser o primeiro nome ou nome completo');
		return;
	}	
	$process.show();
	cleanSearchOutput();
  	$output.hide();
  	$error.hide();
  	var respNames = "";
	splitFullName($.trim($('#fullName').val()),function(response){
		respNames = response;
	});
  	  		
  	var inputSearch = '{'
  		+'"firstName" : "'+$.trim(respNames.firstName)+'",'
		+'"middleName" : "'+$.trim(respNames.middleName)+'",'
		+'"lastName" : "'+$.trim(respNames.lastName)+'"}';
  	  
  	  console.log(JSON.stringify(inputSearch));
  	  
  	  $.ajax({
  		url: '/services/ceai/searchPerson',
        type: 'POST',
        data: inputSearch,
        contentType: "application/json",
        success: function(data, textStatus, jqXHR){
        	alert(data);
        	buildSearhOutput(JSON.parse(data));
            $process.hide();
            $output.show();        
        },
        error: function(jqXHR, textStatus, errorThrown){
        	$('#results').text('Error on Process: '+ jqXHR.responseText+' status: '+jqXHR.statusText);
        	//alert('Error on Process: '+ jqXHR.responseText+' status: '+jqXHR.statusText);
        	 $process.hide();
             $error.show(); 
        }
      });
    });
});